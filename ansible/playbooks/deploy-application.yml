---
- name: Build and Deploy Angular Application
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    project_name: angular-automated-app
    resource_group: "{{ project_name }}-rg"
    acr_name: "{{ project_name | replace('-', '') }}acr"
    web_app_name: "{{ project_name }}"
    docker_image: "{{ acr_name }}.azurecr.io/{{ project_name }}:latest"
  
  tasks:
    - name: Build Docker Image
      shell: |
        docker build -t {{ docker_image }} ../..

    - name: Login to ACR
      shell: |
        az acr login --name {{ acr_name }}

    - name: Push Image to ACR
      shell: |
        docker push {{ docker_image }}

    - name: Update Container Instance
      shell: |
        az container create --resource-group {{ resource_group }} --name {{ web_app_name }} --image {{ docker_image }} --dns-name-label {{ web_app_name }} --ports 80 --registry-login-server {{ acr_name }}.azurecr.io --registry-username {{ acr_name }} --registry-password $(az acr credential show --name {{ acr_name }} --query "passwords[0].value" -o tsv)

    - name: Display Deployment Info
      debug:
        msg:
          - "ðŸš€ Application Deployed Successfully!"
          - "Container URL: http://{{ web_app_name }}.eastus.azurecontainer.io"
          - "Docker Image: {{ docker_image }}"