---
- name: Deploy Complete Azure Infrastructure
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    project_name: angular-automated-app
    location: eastus
    resource_group: "{{ project_name }}-rg"
    acr_name: "{{ project_name | replace('-', '') }}acr"
    app_service_plan: "{{ project_name }}-plan"
    web_app_name: "{{ project_name }}"
  
  tasks:
    - name: Create Resource Group
      shell: |
        az group create --name {{ resource_group }} --location {{ location }}

    - name: Register Azure Providers
      shell: |
        az provider register --namespace Microsoft.ContainerRegistry
        az provider register --namespace Microsoft.Web
        az provider register --namespace Microsoft.Storage

    - name: Create Container Registry
      shell: |
        az acr create --resource-group {{ resource_group }} --name {{ acr_name }} --sku Basic --admin-enabled true

    - name: Create App Service Plan
      shell: |
        az appservice plan create --name {{ app_service_plan }} --resource-group {{ resource_group }} --is-linux --sku B1

    - name: Create Web App
      shell: |
        az webapp create --resource-group {{ resource_group }} --plan {{ app_service_plan }} --name {{ web_app_name }} --deployment-container-image-name nginx:alpine

    - name: Configure Web App Settings
      shell: |
        az webapp config appsettings set --resource-group {{ resource_group }} --name {{ web_app_name }} --settings WEBSITES_ENABLE_APP_SERVICE_STORAGE=false WEBSITES_PORT=80

    - name: Display Infrastructure Info
      debug:
        msg:
          - "âœ… Infrastructure Created Successfully!"
          - "Resource Group: {{ resource_group }}"
          - "Container Registry: {{ acr_name }}.azurecr.io"
          - "Web App URL: https://{{ web_app_name }}.azurewebsites.net"